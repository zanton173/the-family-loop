<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <link rel="manifest" href="/assets/manifest.json" />
    <title>New Game</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/custom-css.min.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/htmx.min.js"></script>
    <script src="/js/htmx_json-enc.js"></script>

    <!--<script src="/js/globalFunctions.js"></script>-->
</head>


<body id="newgamebody" style="overflow: hidden; position: absolute; top: 0; bottom: 0; touch-action: manipulation;">
    <!--<div id="gameNotAvailable">Game not available on this device size!
    </div>-->
    <div id="homeScreen" style="position: absolute; text-align: center; height: 100dvh; width: 100dvw; background-image: linear-gradient(to bottom,
            hsl(199, 90%, 65%),
            hsl(314, 100%, 73%))">
        <div style="height: inherit;">
            <div class="col h-100">
                <div class="row-gap-lg-5"
                    style="font-size: xx-large; margin-top: 10%; height: 15dvh; font-weight: bolder; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif">
                    New Game
                </div>

                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="showLobbyWindow()">start</button>
                </div>
                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="showLeaderboardWindow()">leaderboard</button>
                </div>
                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="location.href = '/'">tfl home</button>
                </div>

            </div>
        </div>
    </div>
    <div id="lobbyWindow" style="display: none; height: 100dvh; width: 100dvw; background-image: linear-gradient(to bottom,
            hsl(199, 90%, 65%),
            hsl(314, 100%, 73%)); position: absolute;">
        <div style='position: absolute; top: .1rem; right: .4rem' id="testconn">
            <p id="connectionId" style="color: green"></p>
        </div>
        <button type="button" class="btn btn-primary" style="position: absolute; top: .4rem; left: .4rem"
            onclick="showHomeWindow()">home</button>
        <div>
            <p style="text-align: center; font-size: xx-large; margin-top: 1rem">Lobby</p>
        </div>
        <div id="connectedPlayers" hx-get="/get-pong-lobby" hx-vals="js:{'username': curUserData}"
            hx-trigger="onOpenLobbyWindow, every 2s" hx-target="#listofplayers">
            <ol id="listofplayers" style="width: 85dvw">

            </ol>

            <div class="p-2 m-2" id="stagingArea">
                <h3 style="text-align: center;">Ready</h3>
            </div>
        </div>
    </div>
    <div id="gameWindow" style="display: none; height: 100dvh; width: 100dvw; background-image: linear-gradient(to bottom,
            hsl(199, 90%, 65%),
            hsl(314, 100%, 73%))">
        <div id="timerBlock"
            style="background: rgb(185 185 185 / 35%); position: absolute; width: 100dvw; height: 100dvh; z-index: 15000;">
            <p id="timerCountdown" style="font-size: 36pt; text-align: center; margin-top: 50%"></p>
        </div>
        <button type="button" class="btn btn-primary" style="position: absolute; top: .4rem; left: .4rem"
            onclick="showHomeWindow()">home</button>
        <div id="gameScreen" style="height: 300px; width: 300px; background: rgb(125 125 125 / 55%); margin: auto;">

            <div id="playerOne"
                style="width: 100px; height: 45px; position: relative; top: 100%; background-color: black; border-width: 2px; margin: auto; border-style: solid; border-color: white; z-index: 17;">
            </div>
            <div id="playerTwo"
                style="display: none; width: 100px; height: 45px; position: relative; top: calc(0% - 90px); background-color: black; border-width: 2px; margin: auto; border-style: solid; border-color: white; z-index: 17;">
                <p id="playerTwoId" style="text-align: center; color: white"></p>
            </div>
            <div id="gameBall"
                style="width: 15px; height: 15px; background: green; position: relative; border-radius: 15px; top: 0px; left: 10%; border-width: thin; border-color: white; box-shadow: 1px 1px 4px black;">

            </div>
        </div>
    </div>

    <script>

        var socket = null
        var curUserData = null
        var gameStateId = null
        var currentPlayerReady = false
        const delay = 1000
        var timer = 4000
        var ballspeed = 20
        var xdirection = 1
        var ydirection = -1
        var ballObj = document.getElementById('gameBall')
        var gameInterval = null
        ballObj.addEventListener("change", () => {
            ballObj.style.left = (Number(ballObj.style.left.split('%')[0]) + xdirection).toString() + "%"
            ballObj.style.top = (Number(ballObj.style.top.split('px')[0]) + ydirection).toString() + "px"
            throwGameball()
        })
        function changeSpeed(newSpeed) {
            ballspeed /= 1.2
            clearInterval(gameInterval)
            gameInterval = setInterval(() => {
                gameBall.dispatchEvent(new Event('change'))
            }, ballspeed)
        }
        function countDownTimer() {
            console.log(timer)
            timer -= delay
            document.getElementById('timerCountdown').innerText = (timer / 1000).toString()
            if (timer === 0) {
                for (var i = 1; i < 99999; i++)
                    window.clearInterval(i);
                document.getElementById('timerBlock').style.display = "none"
                gameInterval = setInterval(() => {
                    gameBall.dispatchEvent(new Event('change'))
                }, ballspeed)
                timer = 4000
            }
        }
        function throwGameball() {
            if (ballObj.style.left == "0%")
                xdirection = 1
            else if (ballObj.style.left == "95%")
                xdirection = -1
            if (Number(ballObj.style.top.split('px')[0]) > 195)
                ydirection = -1
            else if (Number(ballObj.style.top.split('px')[0]) < -89)
                ydirection = 1
        }
        async function getUserData() {
            curUserData = await fetch("/get-username-from-session", {
                method: "GET",
                headers: {
                    "Content-type": "application/json"
                }
            }).then(async (data) => {

                curUserData = await data.json()

                return curUserData.Username
            }).catch((failed) => {
                console.log(failed)
            })
        }
        getUserData()

        async function showLobbyWindow() {

            document.getElementById('connectedPlayers').dispatchEvent(new Event('onOpenLobbyWindow'))
            document.getElementById('homeScreen').style.display = "none"
            document.getElementById('lobbyWindow').style.display = ""
            while (socket === null)
                window.location.protocol === "https:" ? socket = new WebSocket(`wss://${window.location.host}/ws-endpoint`) : socket = new WebSocket(`ws://${window.location.host}:80/ws-endpoint`)

            await fetch("/join-pong-game-lobby", {
                method: "POST",
                headers: {
                    "Content-type": "application/json"
                },
                body: JSON.stringify({ "player": curUserData })
            }).then((data) => {
                if (data.status != 200)
                    alert("Cannot join lobby at this time")
                try {
                    socket.send(JSON.stringify({ "username": curUserData, "data": "true", "type": "lobbyjoin" }))
                }
                catch (err) {
                    console.log(err)
                }
                document.getElementById('connectedPlayers').dispatchEvent(new Event('onOpenLobbyWindow'))
            })
            socket.onopen = () => {
                document.getElementById('connectionId').innerText = "You are connected"
            }
            socket.onmessage = async function (event) {
                var message = JSON.parse(event.data)

                if (message.type === "game") {
                    if (message.username != curUserData)
                        document.getElementById('playerTwo').style.left = message.data
                } else if (message.type === "lobby") {
                    showGameWindow()

                } else if (message.type === curUserData && message.data === "single") {
                    showGameWindow()
                    setTimeout(() => { alert('waiting for 2nd player') }, 400)
                } else if (message.data === "two") {
                    console.log(message)
                    if (document.getElementById('gameWindow').style.display === "none")
                        showGameWindow()

                    document.getElementById('playerTwo').style.display = ""
                    curUserData === message.username ? document.getElementById('playerTwoId').innerText = message.type : document.getElementById('playerTwoId').innerText = message.username

                    var ctimer = setInterval(countDownTimer, delay)
                } else if (message.type === "lobbyjoin") {
                    document.getElementById('connectedPlayers').dispatchEvent(new Event('onOpenLobbyWindow'))
                } else if (message.type === "playertwodisconnected") {
                    alert(message.username + " disconnected")
                    showHomeWindow()
                } else if (message.type === "begin") {
                    if (curUserData === message.username)
                        showGameWindow()
                } else if (message.type === "joinstart") {
                    console.log('teststart')
                }
            }
            socket.onclose = (soc, ev) => {
                fetch(`/delete-from-pong-lobby?username=${curUserData}`, {
                    method: "DELETE",
                })
                document.getElementById('connectionId').style.color = "red"
                document.getElementById('connectionId').innerText = "Refresh the page to connect"
            }

            function sendMessage() {
                socket.send(document.getElementById('wsinput').value)
            }

            function closeConn() {
                socket.close()
            }
        }
        function moveToStage(playername) {
            /*if (document.getElementById('stagingArea').children.length === 3) {
                alert("Game lobby is full")
            } if (currentPlayerReady) {
                alert("You are already ready")
                socket.send(JSON.stringify({ "username": curUserData, "data": "true", "type": "lobby" }))
            } else {
                socket.send(JSON.stringify({ "username": curUserData, "data": "true", "type": "lobby" }))
            currentPlayerReady = true
            }*/
            socket.send(JSON.stringify({ "username": playername, "data": "true", "type": "lobby" }))

        }
        function showGameWindow() {

            setTimeout(() => {
                document.getElementById('homeScreen').style.display = "none"
                document.getElementById('lobbyWindow').style.display = "none"
                document.getElementById('gameWindow').style.display = "grid"
            }, 300)

        }

        document.getElementById('gameWindow')
        const gameNet = document.getElementById('playerOne')
        var currentGameNetPos = 50

        function showHomeWindow() {
            //closeConn()
            fetch(`/delete-from-pong-lobby?username=${curUserData}`, {
                method: "DELETE",
            })
            socket.close()
            socket = null
            document.getElementById('homeScreen').style.display = ""
            document.getElementById('gameWindow').style.display = "none"
            document.getElementById('lobbyWindow').style.display = "none"
        }

        dragElement(document.getElementById('playerOne'));

        function dragElement(elmnt) {

            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            elmnt.onmousedown = dragMouseDown;
            elmnt.ontouchstart = dragMouseDown;

            function dragMouseDown(e) {

                e = e || window.event;
                e.preventDefault();
                // get the mouse cursor position at startup:
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmousemove = elementDrag;
                document.ontouchmove = elementDrag;

                document.onmouseup = closeDragElement;
                document.ontouchend = closeDragElement;
            }

            function elementDrag(e) {

                e = e || window.event;
                e.preventDefault() || null;
                pos1 = pos3 - (e.clientX || e.targetTouches[0].clientX);

                pos3 = e.clientX || e.targetTouches[0].clientX;
                pos4 = e.clientY || e.targetTouches[0].clientY;
                elmnt.style.top = (elmnt.offsetBottom - pos2) + "%";
                //elmnt.style.top = "100%";
                elmnt.style.left = (Number(elmnt.style.left.split("px")[0]) - pos1) + "px";
                //document.getElementById('playerOne').dispatchEvent(new Event('onDraggedEvent'))
                var jsonSend = {
                    "username": curUserData,
                    "data": elmnt.style.left,
                    "type": "game"
                }
                socket.send(JSON.stringify(jsonSend))
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.ontouchend = null;
                document.onmousemove = null;
                document.ontouchmove = null;
                //gameNet.style.top = '100%'
            }
        }

    </script>
    <script type="module">

        import { logoutFunction } from "/js/globalFunctions.js"

        document.addEventListener("onUnauthorizedEvent", () => {

            logoutFunction()
            location.href = "../"
        })
    </script>
</body>

</html>