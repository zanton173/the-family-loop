<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="assets/manifest.json" />
    <link rel="manifest" href="assets/manifest.webmanifest" />
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>-->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom-css.css" rel="stylesheet">
    <script src="js/bootstrap.bundle.min.js"></script>
    <!--<script src="https://unpkg.com/htmx.org@1.9.5"
            integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO"
            crossorigin="anonymous"></script>
            <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>-->
    <script src="js/htmx.min.js"></script>
    <script src="js/htmx_json-enc.js"></script>


    <title>The Family Loop - Group Chat</title>
</head>

<body>
    <div class="spinner-indicator" id="loadingspinner"
        style="width: 100%; height: 100%; background-color: rgb(197, 197, 197);">

        <img width="90px" height="90px" class="spinner-indicator" src="assets/LoadingSpinner.png" />
    </div>
    <h3 style="text-align: center;">Group Chat</h3>

    <div id="anchor">

    </div>
    <div class="modal" tabindex="-1" id="editOrDeleteModal" aria-labelledby="editOrDeleteModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content p-3 border-0 customModalTrans" id="editOrDeleteModalContent">
                <div class="modal-header" style="display: block;">
                    <h4 class="modal-title" style="text-align: center;">Edit or delete</h4>
                </div>

                <div style="text-align: center;">
                    <div style="display: grid; " class="my-1">
                        <input name="usernameinput" id="currentChatMessage" />
                        <button id="changePfpSubmitBtn" class="btn btn-success col my-2" hx-post="/update-selected-chat"
                            hx-on::after-request="editOrDeleteModal.hide()" hx-ext="json-enc" hx-trigger="click"
                            hx-vals="js:{'newMessage': document.getElementById('currentChatMessage').value, 'selectedChatId': selectedChatId}"
                            hx-swap="none" style="padding-top: 2%; width: 50%; margin-left: 25%;">change</button><br />
                    </div>
                    <p style="text-align: center; color: rgba(58, 58, 58, 0.776);">-----------------------------------
                    </p><br />
                    <button type="button" class="btn btn-danger px-5 my-1"
                        hx-on::after-request="editOrDeleteModal.hide()"
                        hx-confirm="This will permanently delete this message. Do you want to continue?"
                        hx-trigger="click" hx-post="/delete-selected-chat"
                        hx-vals="js:{'selectedChatId': selectedChatId}" hx-ext="json-enc" hx-swap="none">delete</button>
                </div>

            </div>
        </div>
    </div>
    <div id="showthemebtn" style="display: block; text-align: center;">
        <button type="button" onclick="showThemePanel()" class="btn btn-dark border-0 btn-sm"
            style="box-shadow: 3px 3px 6px;">Change Theme</button>
    </div>
    <div id="themepanel" style="display: none; text-align: center;">
        <h3>Change background color</h3>
        <input style="width: 25%" class="px-3 mx-1" type="color" oninput="setBgLeftVal()" id="leftsidethemeinput" />
        <input style="width: 25%" class="px-3 mx-1" type="color" oninput="setBgRightVal()" id="rightsidethemeinput" />
        <input style="width: 25%" class="px-3 mx-1" type="range" oninput="setGradPercent()" id="gradientpercentinput"
            min="0" max="100" step="1" /><br />
        <button type="button" onclick="submitTheme()" class="btn btn-dark border-0 btn-sm"
            style="box-shadow: 3px 3px 6px;">save theme</button>
        <button type="button" onclick="showThemePanel()" class="btn btn-dark border-0 btn-sm"
            style="box-shadow: 3px 3px 6px;">close</button>
    </div>
    <div class="text-center my-2">
        <label for="threadSelector">Select Chat Thread:</label>
        <select id="threadSelector" hx-get="/get-open-threads"
            hx-on::after-request="document.getElementById('loadGChathere').dispatchEvent(new Event('afterThreadSelectorLoadsEvent'))"
            hx-swap="beforeend" hx-trigger="load"
            onchange="document.getElementById('loadGChathere').dispatchEvent(new Event('afterThreadSelectorLoadsEvent'))"
            name="threadSelector"
            style="padding: 5px; border: 0; border-radius: 8px / 8px; box-shadow: 3px 3px 7px white;">
        </select>
    </div>
    <div class="modal customModalTrans" id="newThreadModal">
        <div class="modal-dialog">
            <div class="modal-content p-3 my-1 text-center"
                style="background-color: rgb(250 250 250 / 85%); box-shadow: 8px 10px 14px;">
                <div class="modal-header text-center">
                    <h3>New thread:</h3>
                </div>
                <input id="newThreadNameInput" class="m-2" type="text" maxlength="32" placeholder="My thread!" />
                <button class="btn btn-success m-2" data-bs-dismiss="modal" onclick="createNewThread()">create</button>
            </div>
        </div>
    </div>
    <div id="loadGChathere" hx-get="/group-chat-messages"
        hx-vals="js:{'threadval': document.getElementById('threadSelector').value}"
        hx-trigger="afterThreadSelectorLoadsEvent, every 3s, success-send from:#messageform"
        class="border-1 d-block m-2" style="justify-content: center; text-align: center; border-radius: 1%;">

    </div>
    <form hx-post="/create-a-group-chat-message" hx-swap="afterend" hx-target="this" id="messageform"
        hx-on::after-request="clearFormGetMessages()"
        hx-vals="js:{'taggedUser': taggedUser, 'threadval': document.getElementById('threadSelector').value}">
        <div class="d-flex" style="justify-content: center;">
            <div class="container border-1">
                <div id="popovermain" style="display: none; justify-content: center;" class="popover row"
                    role="tooltip">
                    <h3 class="popover-header">tag user</h3>
                    <div id="popbody">

                    </div>

                </div>
                <div class="row" style="justify-content: center; margin-top: 1%;">
                    <input class="col-8 my-0 border-0 text-center"
                        style="border-radius: 18px / 18px; width: 75%; box-shadow: 3px 3px 5px" name="gchatmessage"
                        id="gchatinput" type="text" oninput="checkForTagging()" placeholder="Enter message" required
                        maxlength="420" />
                    <button type="submit" class="col-2 mx-2 border-0 btn btn-success"
                        style="border-radius: 18px / 18px; box-shadow: 3px 3px 5px black;"><i
                            class="bi bi-send"></i></button>
                </div>

            </div>
        </div>
    </form>
    <div class="row" style="justify-content: center; text-align: center; margin-bottom: 5%; margin-top: 1%;">
        <p id="threadPostingTo">loading...</p>
        <button data-bs-toggle="modal" data-bs-target="#newThreadModal" class="btn border-0"
            style="border-radius: 14px / 14px; color: antiquewhite; box-shadow: 1px 1px 3px; background-color: rgb(50 50 50); width: 60%;">Create
            a new
            chat thread!</button>
    </div>
    <script>
        var leftSideVal = null
        var rightSideVal = null
        var gradPercent = null

        var selectedChatId = null

        const editOrDeleteModal = new bootstrap.Modal(document.getElementById('editOrDeleteModal'), {})

        document.addEventListener("DOMContentLoaded", async () => {
            gchatBGTheme = await fetchSeshDetails(document.cookie.split("session_id=")[1])

            document.body.setAttribute('style', gchatBGTheme.BGtheme)

            leftSideVal = document.body.getAttribute("style").split("background: linear-gradient(142deg, ")[1].split(",")[0]
            rightSideVal = document.body.getAttribute("style").split("background: linear-gradient(142deg, " + leftSideVal + ",")[1].split(" ", 2)[1]
            gradPercent = document.body.getAttribute("style").split("background: linear-gradient(142deg, " + leftSideVal + ", " + rightSideVal + " ")[1].split("%")[0]
            document.getElementById('editOrDeleteModalContent').style.background = "linear-gradient(142deg, #ffffff, " + leftSideVal + " 130%)"
            document.getElementById('leftsidethemeinput').value = leftSideVal
            document.getElementById('rightsidethemeinput').value = rightSideVal
            document.getElementById('gradientpercentinput').value = gradPercent
        })
        function setBgLeftVal() {
            leftSideVal = document.getElementById('leftsidethemeinput').value
            document.body.setAttribute("style", "background: linear-gradient(142deg, " + leftSideVal + ", " + rightSideVal + " " + gradPercent + "%)")
        }
        function setBgRightVal() {
            rightSideVal = document.getElementById('rightsidethemeinput').value
            document.body.setAttribute("style", "background: linear-gradient(142deg, " + leftSideVal + ", " + rightSideVal + "  " + gradPercent + "%)")
        }
        function setGradPercent() {
            gradPercent = document.getElementById('gradientpercentinput').value
            document.body.setAttribute("style", "background: linear-gradient(142deg, " + leftSideVal + ", " + rightSideVal + " " + gradPercent + "%)")
        }
        document.getElementById('loadGChathere').addEventListener("afterThreadSelectorLoadsEvent", () => {
            document.getElementById('threadPostingTo').innerHTML = "Posting to: " + document.getElementById('threadSelector').value
        })
        async function submitTheme() {
            const resp = await fetch("/update-gchat-bg-theme", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ theme: "background: linear-gradient(142deg, " + leftSideVal + ", " + rightSideVal + " " + gradPercent + "%)", username })
            }).then((data) => {

            })
        }
        function showThemePanel() {
            if (document.getElementById('showthemebtn').style.display.includes("block") && document.getElementById('themepanel').style.display.includes("none")) {
                document.getElementById('showthemebtn').style.display = "none"
                document.getElementById('themepanel').style.display = "block"
            } else {
                document.getElementById('showthemebtn').style.display = "block"
                document.getElementById('themepanel').style.display = "none"
            }
        }

        async function editOrDeleteChat(chatId) {
            const resp = await fetch("/get-selected-chat?chatid=" + chatId, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            const data = await resp.json()
            document.getElementById('currentChatMessage').value = data
            selectedChatId = chatId
            editOrDeleteModal.show()
        }

        const jsWorker = new Worker("js/worker.js")
        var listOfUsersArr = []
        var taggedUser = ""
        async function checkForTagging() {
            if (document.getElementById('gchatinput').value.includes('@') && document.getElementById('gchatinput').value.split('@')[1] > '') {

                const resp = await fetch("/get-all-users-to-tag?user=" + document.getElementById('gchatinput').value.split('@')[1], {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                listOfUsersArr = await resp.json()
                if (listOfUsersArr != null) {
                    var userStr = ""
                    listOfUsersArr.forEach((item) => {
                        /*var user = document.createElement('p')
                        user.setAttribute('onclick', `selectTaggedUser('${item}')`)
                        user.setAttribute('id', item)
                        user.innerHTML = item*/

                        userStr += `<p onclick=selectTaggedUser('${item}') id='${item}'>${item}</p>`
                        document.getElementById('popbody').innerHTML = userStr

                    })

                } else {
                    document.getElementById('popbody').innerHTML = "No user found..."
                }

                document.getElementById('popovermain').setAttribute("style", "display: block; width: 50%; margin-left: 25%")

            } else {
                document.getElementById('popovermain').setAttribute("style", "display: none")
            }
        }
        function selectTaggedUser(username) {
            document.getElementById('gchatinput').removeAttribute('oninput')
            document.getElementById('gchatinput').focus()
            taggedUser = username
            document.getElementById('gchatinput').value = document.getElementById('gchatinput').value.replace('@'.concat(document.getElementById('gchatinput').value.split('@')[1]), username)
            document.getElementById('popovermain').setAttribute("style", "display: none")
        }
        function clearFormGetMessages() {
            document.getElementById('gchatinput').value = ""
            taggedUser = ""
            document.getElementById('gchatinput').setAttribute('oninput', "checkForTagging()")
        }
        function createNewThread() {
            if (document.getElementById('newThreadNameInput').value > ' ') {
                var newOption = document.createElement("option")
                newOption.setAttribute("value", document.getElementById('newThreadNameInput').value)
                newOption.innerHTML = document.getElementById('newThreadNameInput').value
                document.getElementById('threadSelector').append(newOption)
                newOption.selected = true
                document.getElementById('loadGChathere').dispatchEvent(new Event('afterThreadSelectorLoadsEvent'))
            } else {
                alert("Not a valid thread name")
            }
        }
        htmx.on('#messageform', 'htmx:afterRequest', function (event) {
            event.detail.xhr.status === 401
                && alert("Please login first.")
        })
    </script>
</body>


</html>