<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <link rel="manifest" href="/assets/manifest.json" />
    <title>Stackerz</title>
    <meta name='viewport' content='width=device-width,height=device-height, initial-scale=1.0, user-scalable=no'>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/custom-css.css" rel="stylesheet">
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/htmx.min.js"></script>
    <script src="/js/htmx_json-enc.js"></script>
</head>

<body style="overflow: hidden; position: absolute; top: 0; bottom: 0; touch-action: manipulation;">

    <div id="homeScreen" style="position: absolute; text-align: center; height: 100dvh; width: 100dvw; background-image: linear-gradient(to bottom,
            hsl(264deg 45.29% 56.16%),
            hsl(31, 100%, 40%))">
        <div style="height: inherit;">
            <div class="col h-100">
                <div class="row-gap-lg-5"
                    style="font-size: xx-large; margin-top: 25%; height: 15dvh; font-weight: bolder; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif">
                    Stackerz
                </div>
                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="showGameWindow()">start</button>
                </div>
                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="showLeaderboardWindow()">leaderboard</button>
                </div>
                <div class="row-gap-5 w-35 my-5 h-20">
                    <button class="btn btn-primary p-3"
                        style="border-radius: 18px / 18px; border-width: 3px; border-style: solid; border-color: darkslategray; font-size: larger"
                        onclick="location.href = '/'">tfl home</button>
                </div>

            </div>
        </div>
    </div>
    <div id="gameWindow" style="width: 100dvw; height: 100dvh; overflow: hidden; --game-lvl-width: 200px; display: none; text-align: center; background-image: linear-gradient(to bottom,
            hsl(264deg 45.29% 56.16%),
            hsl(31, 100%, 40%))">

        <button class="btn btn-primary m-1" onclick="showMenuWindow()"
            style="position: absolute; top: 0; left: 0; z-index: 11;">home</button>
        <div style="width: 100dvw; z-index: 10; position: absolute;">
            <p id="levelCount" style="text-align: center; font-size: xx-large; margin-bottom: 0%;">Level: 0</p>
            <p id="bonusPoints" style="text-align: center; font-size: larger;">Bonus: 0</p>
        </div>
        <div id="stopButton" onclick="stopGameObj()"
            style="position: absolute; top: 15%; width: 88%; height: 80dvh; background-color: rgba(215, 214, 212, 0.196); z-index: 3; margin: 6%;">

        </div>

        <div id="winBanner"
            style="position: absolute; z-index: 5; width: 100%; height: 35px; top: 15dvh; display: block; background-color: rgb(110 170 50 / 85%);">
        </div>

        <div id="gameOverDiv"
            style="display: none; position: absolute; z-index: 5; width: 100%; height: 75px; top: 50%; justify-content: center;">
            <button class="btn btn-outline-secondary border-0"
                style="font-size: xx-large; text-align: center; box-shadow: 3px 3px 5px; color: black; background: linear-gradient(140deg, #009415, #f8f9fa 80%)"
                onclick="restartGame()">
                Restart
            </button>
        </div>

        <div id="stGameObj"
            style="background-color: brown; width: 200px; height: 25px; position: absolute; bottom: 0; border-style: solid; border-width: 2px;">
        </div>


    </div>
    <div id="leaderboardWindow" style="display: none; position: absolute; height: 100dvh; width: 100dvw; background-image: linear-gradient(to bottom,
            hsl(264deg 45.29% 56.16%),
            hsl(31, 100%, 40%))">
        <h1 style="text-align: center;">Leaderboard</h1>
        <div hx-get="/get-stackerz-leaderboard" hx-target="#leaderboardLoadTarget"
            hx-trigger="leaderboardOpenedEvent from:#leaderboardWindow"
            style="font-size: larger; text-align: center; margin-top: 10%;">
            <p style="text-align: center; font-weight: bold;">Username - Bonus Points - Level</p>
            <div id="leaderboardLoadTarget">

            </div>
        </div>
        <button class="btn btn-primary m-1" style="position: absolute; top: 0; left: 0;"
            onclick="showMenuWindow()">home</button>
    </div>
    <script>
        var getCurrentUsername = async () => {
            const token = document.cookie.split("session_id=")[1]
            const resp = await fetch("/get-username-from-session?id=" + token, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })

            const text = await resp.json()
            username = await text.Username

            if (username < ' ')
                username = "Guest"

            return username
        }


        var gameLevel = 1
        var bonusPointsCounter = 0
        var curGameObj = document.getElementById('stGameObj')
        const gameWindow = document.getElementById('gameWindow')
        const menuWindow = document.getElementById('homeScreen')
        const leaderboardWindow = document.getElementById('leaderboardWindow')
        const gameObj = document.getElementById("stGameObj")
        const levelCount = document.getElementById('levelCount')
        const bonusPoints = document.getElementById('bonusPoints')
        var newGameObj = document.createElement("div")
        var speed = 1500
        var newGameObjWidth = 125
        var lastStopLeftSide = Number(window.innerWidth - curGameObj.getBoundingClientRect().x)
        var lastStopRightSide = Number(curGameObj.getBoundingClientRect().x + 200)
        function stopGameObj() {

            levelCount.innerHTML = "Level: " + gameLevel
            if (gameLevel > 1) {
                if (Number(window.innerWidth - curGameObj.getBoundingClientRect().x) <= lastStopLeftSide && Number(curGameObj.getBoundingClientRect().x + Number(curGameObj.style.width.replace("px", ""))) <= lastStopRightSide) {
                    bonusPointsCounter += 25
                    bonusPoints.innerHTML = "Bonus: " + bonusPointsCounter
                } else if (
                    Math.abs(Number(window.innerWidth - curGameObj.getBoundingClientRect().x) - lastStopLeftSide) > Number(curGameObj.style.width.replace("px", ""))
                    && Math.abs(Number(curGameObj.getBoundingClientRect().x + Number(curGameObj.style.width.replace("px", ""))) - lastStopRightSide) > Number(curGameObj.style.width.replace("px", ""))
                ) {
                    // Game over
                    levelCount.innerHTML = "Level: " + (gameLevel - 1)
                    document.getElementById(`gameobj_${gameLevel}`).style.display = "none"
                    document.getElementById('stopButton').style.display = "none"
                    document.getElementById('gameOverDiv').style.display = "flex"
                    return
                } else if (curGameObj.getBoundingClientRect().y < document.getElementById('winBanner').getBoundingClientRect().y + 35) {
                    curGameObj.style.animationPlayState = "paused"
                    document.getElementById(`gameobj_${gameLevel}`).style.animationPlayState = "paused"
                    alert("You win")
                    enterScore()
                    showLeaderboardWindow()
                    return
                }

            }
            gameLevel++
            newGameObj = document.createElement("div")
            lastStopLeftSide = Number(window.innerWidth - curGameObj.getBoundingClientRect().x)
            lastStopRightSide = Number(curGameObj.getBoundingClientRect().x + Number(curGameObj.style.width.replace("px", "")))

            if (gameLevel > 3) {
                speed = Math.floor(Math.random() * (1550 - 1000) + 1200)
                newGameObjWidth = 100
            } if (gameLevel > 9) {
                speed = Math.floor(Math.random() * (1450 - 750) + 750)
                newGameObjWidth = 75
            } if (gameLevel > 16) {
                speed = Math.floor(Math.random() * (900 - 300) + 300)
                newGameObjWidth = 50
            }
            curGameObj.style.animationPlayState = "paused"

            curGameObj.style.setProperty("--game-lvl-width", getComputedStyle(gameWindow).getPropertyValue('--game-lvl-width'))
            newGameObj.setAttribute("style", `background-color: rgb(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}); width: ${newGameObjWidth}px; height: 25px; position: absolute; bottom: calc(0% + 25px * ${gameLevel - 1}); border-style: solid; border-width: 2px;`)
            newGameObj.setAttribute("id", `gameobj_${gameLevel}`)
            curGameObj = newGameObj
            newGameObj.style.animation = `bounce ${speed}ms linear infinite`
            gameWindow.append(newGameObj)
            gameWindow.style.setProperty('--game-lvl-width', newGameObj.style.width)
        }
        function restartGame() {
            for (var i = 2; i <= gameLevel; i++) {
                document.getElementById(`gameobj_${i}`).remove()
            }
            newGameObj = document.createElement("div")
            gameLevel = 1
            bonusPointsCounter = 0
            levelCount.innerHTML = "Level: " + gameLevel
            bonusPoints.innerHTML = "Bonus: " + bonusPointsCounter
            speed = 1500
            newGameObjWidth = 125
            lastStopLeftSide = Number(window.innerWidth - curGameObj.getBoundingClientRect().x)
            lastStopRightSide = Number(curGameObj.getBoundingClientRect().x + 200)
            document.getElementById('stopButton').style.display = "block"
            gameObj.style.animationPlayState = "running"
            gameWindow.style.setProperty('--game-lvl-width', "200px")
            document.getElementById('gameOverDiv').style.display = "none"
            curGameObj = gameObj
        }
        function showGameWindow() {
            restartGame()
            menuWindow.style.display = "none"
            leaderboardWindow.style.display = "none"
            if (gameWindow.style.display.includes('none'))
                gameWindow.style.display = ""
            else
                gameWindow.style.display = "none"
        }
        function showMenuWindow() {
            gameWindow.style.display = "none"
            leaderboardWindow.style.display = "none"
            if (menuWindow.style.display.includes('none'))
                menuWindow.style.display = ""
            else
                menuWindow.style.display = "none"
        }
        function showLeaderboardWindow() {
            leaderboardWindow.dispatchEvent(new Event('leaderboardOpenedEvent'))
            gameWindow.style.display = "none"
            menuWindow.style.display = "none"
            if (leaderboardWindow.style.display.includes('none'))
                leaderboardWindow.style.display = ""
            else
                leaderboardWindow.style.display = "none"
        }
        async function enterScore() {
            var curUser = await getCurrentUsername()
            const resp = await fetch("/update-stackerz-score", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ bonus_points: bonusPointsCounter, username: curUser, level: gameLevel })
            }).then(() => {
                leaderboardWindow.dispatchEvent(new Event('leaderboardOpenedEvent'))
            })

        }

    </script>
</body>

</html>