<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/htmx.org@1.9.5"
        integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="./css/calendar.css" />
    <title>The Family Loop - Calendar</title>
</head>

<body>
    <h3 style="text-align: center;">Calendar</h3>
    <div id="anchor">

    </div>
    <div style="text-align: center;">

        <p id="cal-header-for-popover" data-bs-container="body" data-bs-placement="top" data-bs-toggle="popover"
            data-bs-content="If the event is more than one day, you can select just the start & end date
            and the event will be planned for the entire period between." style="font-size: small;">How to
            use
        </p>
    </div>
    <div class="calendar-container">
        <header class="calendar-header">
            <p class="calendar-current-date"></p>

            <div class="calendar-navigation">
                <span id="calendar-prev" class="material-symbols-rounded">
                    <i class="bi bi-arrow-left"></i>
                </span>
                <span id="calendar-next" class="material-symbols-rounded">
                    <i class="bi bi-arrow-right"></i>
                </span>
            </div>
            <br />

        </header>

        <div class="calendar-body">
            <ul class="calendar-weekdays">
                <li>Sun</li>
                <li>Mon</li>
                <li>Tue</li>
                <li>Wed</li>
                <li>Thu</li>
                <li>Fri</li>
                <li>Sat</li>
            </ul>
            <ul class="calendar-dates"></ul>
        </div>
        <div style="text-align: center;" id="add-button-to-submit">

        </div>
        <div class="py-5"></div>
    </div>
</body>
<script>

    const divToAddSubmitTo = document.getElementById('add-button-to-submit')
    const btnToAddEvent = document.createElement('button')

    btnToAddEvent.setAttribute("class", "btn btn-outline-secondary")
    btnToAddEvent.setAttribute("onclick", 'currentSelectedDate()')

    btnToAddEvent.addEventListener("click", async function (event) {
        showStartEndDate()
        const postBody = {
            "start_date": arrayOfDates[0],
            "end_date": arrayOfDates[arrayOfDates.length - 1]
        }
        const resp = await fetch("/create-event", {
            method: "POST",
            headers: {
                "Accept": "application/json",
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postBody)
        })
    })
    btnToAddEvent.innerHTML = "Create new event"

    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))

    const headerEle = document.getElementById('cal-header-for-popover')
    headerEle.addEventListener("mouseover", function (event) {
        popoverList[0].toggle()
    })
    headerEle.addEventListener("mouseout", function (event) {
        popoverList[0].toggle()
    })

    let date = new Date();
    let year = date.getFullYear();
    let month = date.getMonth();

    const day = document.querySelector(".calendar-dates");

    const currdate = document.querySelector(".calendar-current-date");

    const prenexIcons = document.querySelectorAll(".calendar-navigation span");

    // Array of month names
    const months = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
    ];
    // Control item which is selected
    var listOfSelected = []

    // Formatted selected dates
    var arrayOfDates = []

    // Function to generate the calendar
    const manipulate = () => {

        // Get the first day of the month
        let dayone = new Date(year, month, 1).getDay();

        // Get the last date of the month
        let lastdate = new Date(year, month + 1, 0).getDate();

        // Get the day of the last date of the month
        let dayend = new Date(year, month, lastdate).getDay();

        // Get the last date of the previous month
        let monthlastdate = new Date(year, month, 0).getDate();

        // Variable to store the generated calendar HTML
        let lit = "";

        // Stored data for date selection
        let selection = {
            selectedDate: ''
        }

        // Loop to add the last dates of the previous month
        for (let i = dayone; i > 0; i--) {
            lit +=
                `<li class="inactive">${monthlastdate - i + 1}</li>`;
        }

        // Loop to add the dates of the current month
        for (let i = 1; i <= lastdate; i++) {

            // Check if the current date is today
            /*let isToday = i === date.getDate()
                && month === new Date().getMonth()
                && year === new Date().getFullYear()
                ? "active"
                : "";*/
            lit += `<li id='${i}' onclick='toggleActiveElement(${i})'>${i}</li>`;
        }

        // Loop to add the first dates of the next month
        for (let i = dayend; i < 6; i++) {
            lit += `<li class="inactive">${i - dayend + 1}</li>`
        }

        // Update the text of the current date element 
        // with the formatted current month and year
        currdate.innerText = `${months[month]} ${year}`;

        // update the HTML of the dates element 
        // with the generated calendar
        day.innerHTML = lit;
    }
    function toggleActiveElement(data) {

        if (document.getElementById(data).getAttribute("class") <= "") {
            document.getElementById(data).setAttribute("class", "active")
            listOfSelected.push(data)
        } else if (document.getElementById(data).getAttribute("class") >= "") {
            document.getElementById(data).setAttribute("class", "")
            listOfSelected = listOfSelected.filter((filterout) => filterout !== data)
            arrayOfDates = []
        }
        if (listOfSelected.length > 0 && !divToAddSubmitTo.contains(btnToAddEvent)) {
            divToAddSubmitTo.append(btnToAddEvent)
        } else if (listOfSelected.length == 0 && divToAddSubmitTo.contains(btnToAddEvent)) {
            divToAddSubmitTo.removeChild(btnToAddEvent)
        }
    }

    function currentSelectedDate() {
        var monthYear = currdate.innerHTML.split(" ")
        console.log(listOfSelected)
        listOfSelected.forEach(element => {
            arrayOfDates.push(monthYear[0] + " " + element + ", " + monthYear[1])
        });
        arrayOfDates = arrayOfDates.filter((item, index) => arrayOfDates.indexOf(item) === index)


    }
    function showStartEndDate() {
        alert("this is your event start date: " + arrayOfDates[0] + "\n" + "this is your event end date: " + arrayOfDates[arrayOfDates.length - 1])

    }

    manipulate();

    // Attach a click event listener to each icon
    prenexIcons.forEach(icon => {

        // When an icon is clicked
        icon.addEventListener("click", () => {
            listOfSelected = []
            // Check if the icon is "calendar-prev"
            // or "calendar-next"
            month = icon.id === "calendar-prev" ? month - 1 : month + 1;

            // Check if the month is out of range
            if (month < 0 || month > 11) {

                // Set the date to the first day of the 
                // month with the new year
                date = new Date(year, month, new Date().getDate());

                // Set the year to the new year
                year = date.getFullYear();

                // Set the month to the new month
                month = date.getMonth();

            } else {

                // Set the date to the current date
                date = new Date();
            }

            // Call the manipulate function to 
            // update the calendar display
            manipulate();
        });
    });

</script>

</html>