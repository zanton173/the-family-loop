<nav class="navbar navbar-expand-sm navbar-light bg-light" id="ournav" hx-target="#anchor">

    <div class="container">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText"
            aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" style="text-align-last: center; font-size: medium;" id="navbarText">
            <ul class="navbar-nav nav-fill w-100" style="display: contents;" id="navlist">
                <li class="nav-item"><a class="nav-link" href="/calendar">calendar</a></li>
                <li class="nav-item"><a class="nav-link" href="/group-chat">chat</a></li>
                <li class="nav-item"><a class="nav-link" href="/home">posts</a></li>
                <li class="nav-item" id="navitemforwelcome"><button id="loginlogoutnav" class="nav-link"
                        onclick='{loginModal.toggle(); showLoginForm()}'>login</button>
                </li>
            </ul>
        </div>
        <p onclick='scrollToTop()' class="btn" hx-get="/get-posts" style="display: contents;" hx-trigger="click"
            hx-target="#post-items" style="color: blue;" id="notification"></p>
    </div>
</nav>
<div class="modal" tabindex="-1" id="login-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="text-align: center;">Login or Sign Up</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-around;">
                    <button class="btn px-5 btn-outline-secondary" id="login-button"
                        onclick='showLoginForm()'>Login</button>
                    <button class="btn px-5 btn-outline-secondary" id="signup-button"
                        onclick='showSignUpForm()'>Sign-up</button>
                </div>
                <div id="togglesignuplogin">
                    <form class="form" id="login-form" name="loginform" hx-post="/login" hx-trigger="submit"
                        hx-on="loginevent: loginFunction()" hx-swap="none">
                        <div class="p-4">
                            <h5>Login</h5>
                            <label>Username:</label>
                            <input class="form-control" type="text" style="width: 100%" name="usernamelogin"
                                autocomplete="additional-name" placeholder="Username"
                                oninput="checkForValidLoginSubmission()" required id="usernamelogininput" />
                        </div>
                        <div class="p-4">
                            <label>Password:</label>
                            <input class="form-control" style="width: 100%" name="passwordlogin" type="password"
                                autocomplete="new-password" placeholder="Password"
                                oninput="checkForValidLoginSubmission()" required id="passwordlogininput" />
                        </div>
                    </form>
                    <form class="form" id="sign-up-form" name="signupform" hx-post="/signup" hx-trigger="submit"
                        hx-encoding="multipart/form-data" hx-swap="none">
                        <div class="p-4">
                            <h5>Sign Up</h5>
                            <label>Username:</label>
                            <input class="form-control" type="text" name="usernamesignup" autocomplete="additional-name"
                                placeholder="Username" oninput="checkForValidSignUpSubmission()" required
                                id="usernamesignupinput" />
                        </div>
                        <div class="p-4">
                            <label>Password:</label>
                            <input class="form-control" type="password" name="passwordsignup"
                                autocomplete="new-password" placeholder="Password"
                                oninput="checkForValidSignUpSubmission()" required id="passwordsignupinput" />
                        </div>
                        <div class="p-4">
                            <label>Confirm Password:</label>
                            <input class="form-control" type="password" autocomplete="new-password"
                                placeholder="Password" oninput="checkForValidSignUpSubmission()" required
                                id="confirmpasswordsignupinput" name="confirmpasswordsignup" />
                        </div>
                        <div class="p-4">
                            <!-- TODO: Add required PFP -->
                            <label>Pick a profile picture</label>
                            <input id="pfpimage" type="file" accept="image/*" name="pfpformfile" required />

                        </div>
                    </form>
                </div>

            </div>

        </div>
    </div>

</div>
<script>

    let p = document.getElementById('anchor')
    let c = document.getElementById('ournav')

    let signup = document.getElementById('sign-up-form')
    let loginele = document.getElementById('login-form')
    let parentauth = document.getElementById('togglesignuplogin')

    let loginbtn = document.getElementById('login-button')
    let signupbtn = document.getElementById('signup-button')

    let gologin = document.createElement('button')
    let gosignup = document.createElement('button')

    let usernamelogininput = document.getElementById('usernamelogininput')
    let passwordlogininput = document.getElementById('passwordlogininput')

    let usernamesignupinput = document.getElementById('usernamesignupinput')
    let passwordsignupinput = document.getElementById('passwordsignupinput')
    let confirmpasswordsignupinput = document.getElementById('confirmpasswordsignupinput')

    var loginModal = new bootstrap.Modal(document.getElementById('login-modal'), {});

    var navbarItems = document.getElementById('navbarText')

    var navItemToReplace = document.getElementById('navitemforwelcome')
    var navInnerToReplace = document.getElementById('loginlogoutnav')

    const logoutButton = document.createElement('button')
    logoutButton.setAttribute("class", "btn btn-outline-secondary")

    logoutButton.setAttribute("onclick", 'logoutFunction()')
    logoutButton.innerHTML = "Logout"

    const navItemWelcome = document.createElement('li')
    const divToStickNav = document.createElement('div')
    divToStickNav.setAttribute("style", "display: contents;")

    navItemWelcome.setAttribute("class", "nav-item")

    const navItemWelcomeAvatar = document.createElement('img')
    navItemWelcomeAvatar.setAttribute("class", "border-0 mx-3")
    // clip-path: inset(30px 7px 30px 7px round 100%)
    navItemWelcomeAvatar.setAttribute("style", "width: 8%; height: auto; border-radius: 35%;")
    navItemWelcomeAvatar.setAttribute("src", "https://the-family-loop-customer-hash.s3.amazonaws.com/pfp/question.png")

    navItemWelcomeAvatar.setAttribute("alt", "Your family loop pfp")
    //navItemWelcome.innerHTML = "Welcome, "
    p.append(c)

    document.body.addEventListener("htmx:load", function settleEvent(event) {

        let name = "session_id=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {

                htmx.off("htmx:load", settleEvent)
                //console.log(c.substring(name.length, c.length))
                let session_token = c.substring(name.length, c.length)
                fetchSeshDetails(session_token)

                divToStickNav.append(navItemWelcomeAvatar)
                divToStickNav.append(logoutButton)

                document.getElementById('navlist').removeChild(navItemToReplace)
                navbarItems.append(divToStickNav)

                break
            }
        }


    })
    async function fetchSeshDetails(token) {
        //console.log(token)
        const resp = await fetch("/get-username-from-session?id=" + token, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })

        const text = await resp.json()

        if (text.Pfpname === '') {
            navItemWelcomeAvatar.setAttribute("src", "https://the-family-loop-customer-hash.s3.amazonaws.com/pfp/question.png")
        }
        navItemWelcomeAvatar.setAttribute("src", "https://the-family-loop-customer-hash.s3.amazonaws.com/pfp/question.png" + text.Pfpname)
    }
    async function clearCookie() {
        const resp = await fetch("/clear-cookie", {
            method: "GET",
        })
        //console.log(resp)
    }
    function logoutFunction() {
        clearCookie().then(() => {
            document.cookie = "session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            window.location.reload()
        })

    }

    function showSignUpForm() {

        if (parentauth.childElementCount >= 1) {
            signupbtn.setAttribute('class', 'btn px-5 btn-secondary')

            loginbtn.setAttribute('class', 'btn px-5 btn-outline-secondary')
            if (parentauth.contains(loginele)) {
                parentauth.removeChild(loginele)
            }
            parentauth.appendChild(signup)
        }
    }
    function showLoginForm() {

        if (parentauth.childElementCount >= 1) {
            loginbtn.setAttribute('class', 'btn px-5 btn-secondary')
            signupbtn.setAttribute('class', 'btn px-5 btn-outline-secondary')
            if (parentauth.contains(signup)) {
                parentauth.removeChild(signup)
            }
            parentauth.appendChild(loginele)
        }
    }
    function checkForValidLoginSubmission() {

        if (usernamelogininput.value > '' && passwordlogininput.value > '') {

            gologin.setAttribute("type", "submit")
            gologin.setAttribute("class", "btn btn-outline-success")
            gologin.setAttribute("data-bs-dismiss", "modal")

            gologin.innerHTML = "Go!"

            loginele.append(gologin)
        } else if ((usernamelogininput.value == '' || passwordlogininput.value == '') && loginele.contains(gologin)) {
            loginele.removeChild(gologin)
        }
    }
    function checkForValidSignUpSubmission() {
        if (usernamesignupinput.value > '' && passwordsignupinput.value > '' && passwordsignupinput.value === confirmpasswordsignupinput.value) {

            gosignup.setAttribute("type", "submit")
            gosignup.setAttribute("class", "btn btn-outline-success")
            gosignup.setAttribute("data-bs-dismiss", "modal")

            gosignup.innerHTML = "Go!"

            signup.append(gosignup)

        } else if ((usernamesignupinput.value == '' || passwordsignupinput.value == '' || confirmpasswordsignupinput.value == '' || passwordsignupinput.value !== confirmpasswordsignupinput.value) && signup.contains(gosignup)) {

            signup.removeChild(gosignup)

        }
    }

    htmx.on("#sign-up-form", "htmx:afterRequest", function (event) {
        if (event.detail.xhr.status == 401) {
            alert("Are you trying to bypass client side validation??!?!?!")
        } else if (event.detail.xhr.status == 200) {
            alert('Sign up Successful! You can now login');
            loginModal.toggle();
            showLoginForm();
        } else if (event.detail.xhr.status == 400) {
            alert("Something was wrong with the picture you provided. Try a different one")
        }
    })


    function loginFunction() {
        alert("username or password incorrect")

        loginModal.toggle()
        showLoginForm()
    }

</script>