<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="assets/manifest.json" />
    <link rel="manifest" href="assets/manifest.webmanifest" />
    <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>-->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/custom-css.css" rel="stylesheet">
    <script src="js/bootstrap.bundle.min.js"></script>
    <!--<script src="https://unpkg.com/htmx.org@1.9.5"
            integrity="sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO"
            crossorigin="anonymous"></script>
            <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>-->
    <script src="js/htmx.min.js"></script>
    <script src="js/htmx_json-enc.js"></script>


    <title>The Family Loop - Group Chat</title>
</head>

<body>
    <div class="spinner-indicator" id="loadingspinner"
        style="width: 100%; height: 100%; background-color: rgb(197, 197, 197);">

        <img width="90px" height="90px" class="spinner-indicator" src="assets/LoadingSpinner.png" />
    </div>
    <h3 style="text-align: center;">Group Chat</h3>
    <div id="anchor">

    </div>

    <div hx-get="/group-chat-messages" hx-trigger="load, every 3s, success-send from:#messageform"
        class="border-1 d-block m-2"
        style="justify-content: center; text-align: center; background-color: rgb(205, 205, 206); border-radius: 1%;">

    </div>
    <form hx-post="/create-a-group-chat-message" hx-swap="afterend" hx-target="this" id="messageform"
        hx-on::after-request="clearFormGetMessages()" hx-vals="js:{'taggedUser': taggedUser}">
        <div class="d-flex" style="justify-content: center; margin-bottom: 8%;">
            <div class="container border-1">
                <div id="popovermain" style="display: none; justify-content: center;" class="popover row"
                    role="tooltip">
                    <h3 class="popover-header">tag user</h3>
                    <div id="popbody">

                    </div>

                </div>
                <div class="row" style="justify-content: center;">
                    <input class="col-8 my-0 border-2 text-center" style="border-radius: 3%; width: 75%;"
                        name="gchatmessage" id="gchatinput" type="text" oninput="checkForTagging()"
                        placeholder="Enter message" required maxlength="420" />
                    <button type="submit" class="col-2 btn btn-outline-success"><i class="bi bi-send"></i></button>
                </div>
            </div>
        </div>
    </form>
    <script>
        const jsWorker = new Worker("js/worker.js")
        var listOfUsersArr = []
        var taggedUser = ""
        async function checkForTagging() {
            if (document.getElementById('gchatinput').value.includes('@') && document.getElementById('gchatinput').value.split('@')[1] > '') {

                const resp = await fetch("/get-all-users-to-tag?user=" + document.getElementById('gchatinput').value.split('@')[1], {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                listOfUsersArr = await resp.json()
                if (listOfUsersArr != null) {
                    listOfUsersArr.forEach((item) => {
                        /*var user = document.createElement('p')
                        user.setAttribute('onclick', `selectTaggedUser('${item}')`)
                        user.setAttribute('id', item)
                        user.innerHTML = item*/
                        userStr = `<p onclick=selectTaggedUser('${item}') id='${item}'>${item}</p>`
                        document.getElementById('popbody').innerHTML = userStr

                    })
                } else {
                    document.getElementById('popbody').innerHTML = "No user found..."
                }

                document.getElementById('popovermain').setAttribute("style", "display: block; width: 50%; margin-left: 25%")

            } else {
                document.getElementById('popovermain').setAttribute("style", "display: none")
            }
        }
        function selectTaggedUser(username) {
            document.getElementById('gchatinput').removeAttribute('oninput')
            document.getElementById('gchatinput').focus()
            taggedUser = username
            document.getElementById('gchatinput').value = document.getElementById('gchatinput').value.replace('@'.concat(document.getElementById('gchatinput').value.split('@')[1]), username)
            document.getElementById('popovermain').setAttribute("style", "display: none")
        }
        function clearFormGetMessages() {
            document.getElementById('gchatinput').value = ""
            taggedUser = ""
            document.getElementById('gchatinput').setAttribute('oninput', "checkForTagging()")
        }
        htmx.on('#messageform', 'htmx:afterRequest', function (event) {


            event.detail.xhr.status === 401
                && alert("Please login first.")
        })
    </script>
</body>


</html>